<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Upload Delivery Order PDF</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 2rem auto; padding: 1rem; }
    .card { border: 1px solid #ddd; padding: 1.2rem; border-radius: 8px; }
    input[type=file] { display:block; margin-bottom: 1rem; }
    button { padding: 0.6rem 1rem; font-size: 1rem; cursor: pointer; }

    /* Loading overlay – full page */
    .loading-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: #fff;
      z-index: 9999;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 1.5rem;
    }
    .loading-overlay.active { display: flex; }

    .loading-title {
      font-size: 1.25rem;
      color: #444;
      margin: 0;
    }

    /* Progress bar container – thin bar */
    .progress-wrap {
      width: 90%;
      max-width: 420px;
      background: #fff;
      border-radius: 999px;
      padding: 3px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid #2563eb;
    }

    .progress-track {
      height: 8px;
      background: #bfdbfe;
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: #2563eb;
      border-radius: 999px;
      transition: width 0.25s ease-out;
    }

    .loading-overlay .error-msg {
      color: #b91c1c;
      font-size: 0.95rem;
      max-width: 90%;
      text-align: center;
    }

    .loading-overlay .dismiss-btn {
      padding: 0.5rem 1rem;
      cursor: pointer;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.95rem;
    }
    .loading-overlay .dismiss-btn:hover { background: #1d4ed8; }
  </style>
</head>
<body>
  <h1>Upload Electric Bill (PDF)</h1>
  <div class="card">
    <form id="uploadForm" action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data">
      <label for="file">Choose PDF file:</label>
      <input type="file" name="file" id="file" accept="application/pdf" required>
      <button type="submit" id="submitBtn">Upload & Extract</button>
    </form>
  </div>
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <ul>
        {% for m in messages %}
          <li style="color: red;">{{ m }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}

  <!-- Loading overlay with progress bar -->
  <div class="loading-overlay" id="loadingOverlay" aria-live="polite">
    <p class="loading-title">Extracting data from PDF</p>
    <div class="progress-wrap">
      <div class="progress-track">
        <div class="progress-fill" id="progressFill" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
    </div>
    <p class="error-msg" id="loadingError" style="display: none;"></p>
    <button type="button" class="dismiss-btn" id="dismissBtn" style="display: none;">Dismiss</button>
  </div>

  <script>
    (function () {
      var form = document.getElementById("uploadForm");
      var overlay = document.getElementById("loadingOverlay");
      var progressFill = document.getElementById("progressFill");
      var loadingError = document.getElementById("loadingError");
      var dismissBtn = document.getElementById("dismissBtn");
      var submitBtn = document.getElementById("submitBtn");

      var progressInterval = null;
      var targetPercent = 0;

      function setProgress(percent) {
        targetPercent = Math.min(100, Math.max(0, percent));
        progressFill.style.width = targetPercent + "%";
        progressFill.setAttribute("aria-valuenow", Math.round(targetPercent));
      }

      function hideOverlay() {
        overlay.classList.remove("active");
        loadingError.style.display = "none";
        dismissBtn.style.display = "none";
        if (progressInterval) {
          clearInterval(progressInterval);
          progressInterval = null;
        }
        setProgress(0);
      }

      function showError(msg) {
        loadingError.textContent = msg;
        loadingError.style.display = "block";
        dismissBtn.style.display = "inline-block";
        setProgress(0);
      }

      function runSimulatedProgress() {
        var start = 0;
        var duration = 8000; // advance toward 90% over 8 seconds
        var startTime = Date.now();
        progressInterval = setInterval(function () {
          var elapsed = Date.now() - startTime;
          var p = Math.min(90, (elapsed / duration) * 90);
          setProgress(p);
        }, 150);
      }

      form.addEventListener("submit", function (e) {
        e.preventDefault();
        var fileInput = document.getElementById("file");
        if (!fileInput.files || !fileInput.files.length) return;

        overlay.classList.add("active");
        loadingError.style.display = "none";
        dismissBtn.style.display = "none";
        setProgress(0);
        runSimulatedProgress();

        var formData = new FormData(form);
        var xhr = new XMLHttpRequest();

        xhr.open("POST", form.action);
        xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
        xhr.responseType = "json";

        xhr.onload = function () {
          if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
          }
          setProgress(100);

          var res = xhr.response;
          if (!res || typeof res !== "object") {
            showError("Invalid response from server.");
            return;
          }
          if (res.success && res.redirect) {
            setTimeout(function () {
              window.location.href = res.redirect;
            }, 300);
            return;
          }
          showError(res.message || "Something went wrong.");
        };

        xhr.onerror = function () {
          if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
          }
          showError("Network error. Please try again.");
        };

        xhr.send(formData);
      });

      dismissBtn.addEventListener("click", hideOverlay);
    })();
  </script>
</body>
</html>
