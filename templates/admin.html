<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Admin - Delivery Orders</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; max-width: 1200px; margin: 2rem auto; padding: 1rem; }
    .table-container { overflow-x: auto; margin-top: 1rem; }
    table { border-collapse: collapse; width: 100%; }
    td, th { border: 1px solid #ddd; padding: 0.6rem; text-align: left; font-size: 0.9rem; }
    th { background-color: #f4f4f4; font-weight: bold; position: sticky; top: 0; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .empty { text-align: center; padding: 2rem; color: #666; }
    a { color: #0066cc; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .selection-controls { margin: 1rem 0; display: flex; align-items: center; gap: 1rem; padding: 1rem; background-color: #f0f0f0; border: 2px solid #ddd; border-radius: 4px; }
    .delete-btn { background-color: #dc3545; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; font-size: 1rem; font-weight: bold; }
    .delete-btn:hover { background-color: #c82333; }
    .delete-btn:disabled { background-color: #ccc; cursor: not-allowed; }
    .select-all-checkbox, .row-checkbox { width: 24px; height: 24px; cursor: pointer; margin: 0; }
    .selected-count { color: #333; font-size: 1rem; font-weight: 500; }
    .desc-cell { max-width: 320px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  </style>
</head>
<body>
  <h1>Delivery Orders</h1>
  <p><a href="{{ url_for('index') }}">Upload New Delivery Order</a></p>

  {% if orders %}
    <p><strong>Total orders: {{ orders|length }}</strong></p>

    <form id="deleteForm" method="POST" action="{{ url_for('delete_bills') }}">
      <div class="selection-controls">
        <button type="submit" class="delete-btn" id="deleteBtn" disabled>Delete Selected (<span id="selectedCount">0</span>)</button>
        <span class="selected-count" id="selectedText"></span>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th><input type="checkbox" class="select-all-checkbox" id="selectAll" title="Select All"></th>
              <th>ID</th>
              <th>Filename</th>
              <th>Delivery To</th>
              <th>Delivery Order No</th>
              <th>Date</th>
              <th>Description &amp; Size</th>
              <th>Total Weight</th>
            </tr>
          </thead>
          <tbody>
            {% for order in orders %}
            <tr>
              <td><input type="checkbox" class="row-checkbox" name="order_ids" value="{{ order.id }}" title="Select this order"></td>
              <td>{{ order.id }}</td>
              <td>{{ order.filename }}</td>
              <td>{{ order.delivery_to or '—' }}</td>
              <td>{{ order.delivery_order_no or '—' }}</td>
              <td>{{ order.date.strftime('%Y-%m-%d') if order.date else '—' }}</td>
              <td class="desc-cell" title="{{ order.description_size or '' }}">{{ order.description_size or '—' }}</td>
              <td>{{ "%.3f"|format(order.total_weight) if order.total_weight else '—' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </form>
  {% else %}
    <div class="empty">
      <p>No delivery orders uploaded yet.</p>
      <p><a href="{{ url_for('index') }}">Upload your first delivery order</a></p>
    </div>
  {% endif %}

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <ul style="color: red; margin-top: 1rem;">
        {% for m in messages %}
          <li>{{ m }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}

  <script>
    const selectAllCheckbox = document.getElementById('selectAll');
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    const deleteBtn = document.getElementById('deleteBtn');
    const selectedCount = document.getElementById('selectedCount');
    const selectedText = document.getElementById('selectedText');
    const deleteForm = document.getElementById('deleteForm');

    function updateSelectionUI() {
      const checked = document.querySelectorAll('.row-checkbox:checked');
      const count = checked.length;
      selectedCount.textContent = count;
      deleteBtn.disabled = count === 0;

      if (count > 0) {
        selectedText.textContent = count + ' item' + (count > 1 ? 's' : '') + ' selected';
      } else {
        selectedText.textContent = '';
      }

      if (rowCheckboxes.length > 0) {
        selectAllCheckbox.checked = count === rowCheckboxes.length;
        selectAllCheckbox.indeterminate = count > 0 && count < rowCheckboxes.length;
      }
    }

    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', function() {
        rowCheckboxes.forEach(cb => { cb.checked = this.checked; });
        updateSelectionUI();
      });
    }

    rowCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', updateSelectionUI);
    });

    if (deleteForm) {
      deleteForm.addEventListener('submit', function(e) {
        const checked = document.querySelectorAll('.row-checkbox:checked');
        if (checked.length === 0) {
          e.preventDefault();
          return false;
        }
        if (!confirm('Are you sure you want to delete ' + checked.length + ' selected item(s)? This cannot be undone.')) {
          e.preventDefault();
          return false;
        }
      });
    }

    updateSelectionUI();
  </script>
</body>
</html>
